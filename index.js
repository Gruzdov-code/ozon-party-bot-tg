import {Telegraf} from "telegraf";
import {showMenu} from "./menu.js";
import fs from "fs";
const data = fs.readFileSync("./users.json", "utf8", (err, data) => {
  if (err) throw err;

});
  global.users = JSON.parse(data);
  global.userIdList= Object.keys(users)
// const HttpsProxyAgent = require('https-proxy-agent');
// –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
const config = {
  "token": "6476063403:AAGQmIo4bMkHEIkWwa77qNfo3dYQuO_03eQ", // –¢–æ–∫–µ–Ω –±–æ—Ç–∞
  "admin": 111, // —è
  // "admin": 451019148, // —è
  "barman": 639611757, // –í–æ–≤–∞
  "barman4": 559085599, // –ü—Ä–æ—à–∞
  "barman2": 197813146, // –õ–µ—Ä–∞
  // "barman3": 418259847 // –ö–æ–ª—Ç
};
// –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –±–æ—Ç–∞
const bot = new Telegraf(config.token, {
      // –ï—Å–ª–∏ –Ω–∞–¥–æ —Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ - —É–∫–∞–∂–∏—Ç–µ: user, pass, host, port
      // telegram: { agent: new HttpsProxyAgent('http://user:pass@host:port') }
    }
);
// –¢–µ–∫—Å—Ç–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
let replyText = {
  "helloAdmin": "–ü—Ä–∏–≤–µ—Ç –∞–¥–º–∏–Ω, –∂–¥–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
  "helloUser":  "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ—Å—Ç–∞—Ä–∞—é—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.",
  "replyWrong": "–î–ª—è –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –û—Ç–≤–µ—Ç–∏—Ç—å/Reply."
};
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –ø—Ä–∞–≤–∞
let isAdmin = (userId) => {
  return userId == config.admin;
};
let isBarman = (userId) => {
  return userId == (config.barman || config.barman2 || config.barman4);
};


// const
const coctailList = userIdList.flatMap((el)=>{
  const result=[]
  result.push(...users[el].coctailList)
  return [...result]
})
const availableCoctails = []
 coctailList.map((el)=>{
  el.isAvailable ? availableCoctails.push([{text:el.fullName , callback_data:el.shortName}]) : ''
  return availableCoctails
})

 const replyToUser = async (query, searchCoctail, userId) =>{
      bot.telegram.sendMessage(query.update.callback_query.from.id, '–í–∂—É—Ö! –ú—ã —É–∂–µ –≥–æ—Ç–æ–≤–∏–º —Ç–≤–æ–π –∫–æ–∫—Ç–µ–π–ª—å. +\n' +
        `–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: ${searchCoctail.shortName+users[userId].orders.length}`)
      bot.telegram.sendMessage(query.update.callback_query.from.id, '–ê –ø–æ–∫–∞ –∂–¥–µ—à—å, –¥–æ–±–∞–≤—å —Å–µ–±–µ —Å—Ç–∏–∫–µ—Ä-–ø–∞–∫ –æ—Ç OZON –ë–∞–Ω–∫–∞ –¥–ª—è –æ—Å–æ–±–æ –≤–∞–∂–Ω—ã—Ö –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤üòé')
      query.replyWithSticker('CAACAgIAAxkBAAIC0mZTlQ_Saj1mRPa8XDt8sUCaXDiSAALKQgACl_AxSsv-hHMxONVnNQQ')

}


// –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—É –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —É–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞ –æ–± –æ—à–∏–±–∫–µ
// –°—Ç–∞—Ä—Ç –±–æ—Ç–∞
bot.start((ctx) => {
  // if ()
  console.log('ctx', ctx.message.from.id)
  ctx.reply(isAdmin(ctx.message.from.id)
      ? replyText.helloAdmin
      : replyText.helloUser);
});
// –°–ª—É—à–∞–µ–º –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ–±—ä–µ–∫—Ç–∞ message
bot.on('message', (ctx) => {
  console.log('ctx',ctx.message)
if (ctx.message.text=='start'){
  showMenu(bot,ctx.message.chat.id,availableCoctails)
}
})

bot.on('callback_query', query => {


  for(let userId in users) {
    if (!users) return
   const searchCoctail = users[userId].coctailList.find((coctail)=> coctail.shortName===query.update.callback_query.data)
    if (searchCoctail){
      users[userId].orders.push({
        "number": searchCoctail.shortName+users[userId].orders.length,
        "createdAt": new Date(),
        "isDone": false
      })
      fs.writeFileSync("./users.json", JSON.stringify(global.users), (err) => {
        if (err) throw err;
      });
        replyToUser(query,searchCoctail, userId).then(res=>(console.log('res',res))).catch(err=>( console.log('err',err)))
    }
  }
})


// –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç
bot.launch();